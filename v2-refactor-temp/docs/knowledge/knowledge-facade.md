# KnowledgeFacade è®¾è®¡æ–‡æ¡£

## æ¦‚è¿°

`KnowledgeFacade` æ˜¯çŸ¥è¯†åº“ç³»ç»Ÿå¯¹å¤–çš„ç»Ÿä¸€æ¥å£å±‚ï¼Œä¸º MCP Toolsã€HTTP APIã€Agent ç­‰å¤–éƒ¨è°ƒç”¨è€…æä¾›ç®€æ´ã€å®‰å…¨çš„ APIã€‚

## æ¶æ„å±‚çº§

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         External Access Layer                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚   â”‚   MCP Tools   â”‚    â”‚   HTTP API    â”‚    â”‚  Agent Tools  â”‚               â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚           â”‚                    â”‚                    â”‚                        â”‚
â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â”‚                                â–¼                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚                      KnowledgeFacade                                 â”‚   â”‚
â”‚   â”‚                      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                                 â”‚   â”‚
â”‚   â”‚   å¯¹å¤–æä¾›ç»Ÿä¸€ã€ç®€æ´çš„ API                                            â”‚   â”‚
â”‚   â”‚                                                                      â”‚   â”‚
â”‚   â”‚   ğŸ“— æ ‡å‡†æ¨¡å¼ (Safe Mode)                                            â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ addDocument(baseId, input) â†’ itemId                           â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ search(baseId, query) â†’ results                               â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ getJobStatus(itemId) â†’ status                                 â”‚   â”‚
â”‚   â”‚   â””â”€â”€ removeDocument(baseId, itemId)                                â”‚   â”‚
â”‚   â”‚                                                                      â”‚   â”‚
â”‚   â”‚   âš¡ ä¸Šå¸æ¨¡å¼ (God Mode)                                             â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ rawQuery(baseId, sql) â†’ results                               â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ updateChunkMetadata(baseId, chunkId, metadata)                â”‚   â”‚
â”‚   â”‚   â””â”€â”€ getChunks(baseId, itemId) â†’ chunks                            â”‚   â”‚
â”‚   â”‚                                                                      â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                â”‚                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      DataApi Layer (ç°æœ‰)                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚  KnowledgeBaseService          â”‚        KnowledgeItemService        â”‚   â”‚
â”‚   â”‚  (SQLite CRUD - Base)          â”‚        (SQLite CRUD - Items)       â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                â”‚                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Service Layer (å·²é‡æ„)                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                â–¼                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚                    KnowledgeOrchestrator                             â”‚   â”‚
â”‚   â”‚                    (åè°ƒå±‚ - çŠ¶æ€ç®¡ç†)                                â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                â”‚                                             â”‚
â”‚                                â–¼                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚                    KnowledgeProcessor                                â”‚   â”‚
â”‚   â”‚                    (å¤„ç†å±‚ - ä¸šåŠ¡æµç¨‹)                                â”‚   â”‚
â”‚   â”‚                    OCR â†’ Read â†’ Embed â†’ Store                        â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                â”‚                                             â”‚
â”‚                                â–¼                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚                    KnowledgeQueueManager                             â”‚   â”‚
â”‚   â”‚                    (è°ƒåº¦å±‚ - å¹¶å‘æ§åˆ¶)                                â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                â”‚                                             â”‚
â”‚                                â–¼                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚                    KnowledgeServiceV2                                â”‚   â”‚
â”‚   â”‚                    (å­˜å‚¨å±‚ - å‘é‡æ“ä½œ)                                â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## å±‚çº§èŒè´£

| å±‚çº§ | è°ƒç”¨è€… | èŒè´£ |
|------|--------|------|
| **KnowledgeFacade** | MCP/API/Agent | å¯¹å¤–ç®€åŒ–æ¥å£ï¼Œéšè—å†…éƒ¨ç»†èŠ‚ |
| **DataApi Services** | Renderer UI / Facade | SQLite CRUD + è°ƒç”¨ Orchestrator |
| **Orchestrator** | DataApi Services | åè°ƒå¤„ç†æµç¨‹ï¼Œç®¡ç†çŠ¶æ€å›è°ƒ |
| **Processor** | Orchestrator | å°è£… OCR â†’ Read â†’ Embed æµç¨‹ |
| **QueueManager** | Processor | ä»»åŠ¡è°ƒåº¦ï¼Œå¹¶å‘æ§åˆ¶ |
| **ServiceV2** | Processor | å‘é‡å­˜å‚¨ï¼Œæœç´¢ï¼Œé‡æ’åº |

## Facade vs DataApi æœåŠ¡çš„åŒºåˆ«

| ç»´åº¦ | DataApi æœåŠ¡ | KnowledgeFacade |
|------|-------------|-----------------|
| **é¢å‘å¯¹è±¡** | å†…éƒ¨ UI (Renderer) | å¤–éƒ¨ç³»ç»Ÿ (MCP, API, Agent) |
| **æ¥å£é£æ ¼** | CRUD é£æ ¼ï¼Œæš´éœ² DTO | ä¸šåŠ¡è¯­ä¹‰ï¼Œéšè—ç»†èŠ‚ |
| **è¿”å›å€¼** | å®Œæ•´å®ä½“ (KnowledgeItem) | ç®€åŒ–ç»“æœ (åªå«å¿…è¦ä¿¡æ¯) |
| **é”™è¯¯å¤„ç†** | DataApiError | ä¸šåŠ¡å‹å¥½çš„é”™è¯¯ä¿¡æ¯ |
| **ä¸Šå¸æ¨¡å¼** | æ—  | æœ‰ (rawQuery, updateChunkMetadata) |

## API è®¾è®¡

### ç±»å‹å®šä¹‰

```typescript
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// è¾“å…¥ç±»å‹
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

interface AddDocumentInput {
  type: 'file' | 'url' | 'note' | 'sitemap' | 'directory'
  data: KnowledgeItemData
  metadata?: Record<string, unknown>
}

interface SearchOptions {
  topK?: number
  threshold?: number
  rerank?: boolean
  filter?: {
    itemIds?: string[]
    metadata?: Record<string, unknown>
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// è¾“å‡ºç±»å‹
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

interface AddDocumentResult {
  itemId: string
  status: 'queued' | 'processing' | 'completed' | 'failed'
}

interface SearchResult {
  content: string
  score: number
  metadata: Record<string, unknown>
  itemId?: string
  chunkId?: string
}

interface JobStatus {
  status: 'queued' | 'processing' | 'completed' | 'failed'
  progress: number
  error?: string
  stage?: 'ocr' | 'read' | 'embed'
}

interface ChunkInfo {
  id: string
  content: string
  metadata: Record<string, unknown>
  embedding?: number[]
}
```

### Facade ç±»

```typescript
class KnowledgeFacade {
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ğŸ“— æ ‡å‡†æ¨¡å¼ - ç®€å•å®‰å…¨çš„æ“ä½œ
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  /**
   * æ·»åŠ æ–‡æ¡£åˆ°çŸ¥è¯†åº“ (å¼‚æ­¥)
   * @returns itemId ç”¨äºæŸ¥è¯¢å¤„ç†çŠ¶æ€
   */
  async addDocument(baseId: string, input: AddDocumentInput): Promise<AddDocumentResult>

  /**
   * æœç´¢çŸ¥è¯†åº“ (åŒæ­¥)
   */
  async search(baseId: string, query: string, options?: SearchOptions): Promise<SearchResult[]>

  /**
   * æŸ¥è¯¢å¤„ç†çŠ¶æ€
   */
  async getJobStatus(itemId: string): Promise<JobStatus>

  /**
   * åˆ é™¤æ–‡æ¡£ (åŒæ­¥)
   */
  async removeDocument(baseId: string, itemId: string): Promise<void>

  /**
   * åˆ—å‡ºçŸ¥è¯†åº“ä¸­çš„æ–‡æ¡£
   */
  async listDocuments(baseId: string, options?: { status?: ItemStatus }): Promise<DocumentInfo[]>

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // âš¡ ä¸Šå¸æ¨¡å¼ - ç›´æ¥æ“ä½œåº•å±‚
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  /**
   * ç›´æ¥æ‰§è¡Œ SQL æŸ¥è¯¢ (åªè¯»)
   * ç”¨äº: Agent æŸ¥è¯¢çŸ¥è¯†åº“ç»Ÿè®¡ä¿¡æ¯ã€è°ƒè¯•ç­‰
   */
  async rawQuery(baseId: string, sql: string): Promise<unknown[]>

  /**
   * è·å–æ–‡æ¡£çš„æ‰€æœ‰ chunks
   * ç”¨äº: Agent æ£€æŸ¥åˆ†å—ç»“æœã€è°ƒè¯•
   */
  async getChunks(baseId: string, itemId: string): Promise<ChunkInfo[]>

  /**
   * æ›´æ–° chunk çš„ metadata (Agent æ ‡æ³¨)
   * ç”¨äº: Agent æ·»åŠ æ ‡ç­¾ã€è¯„åˆ†ã€æ ‡è®°è¿‡æ—¶ç­‰
   */
  async updateChunkMetadata(
    baseId: string,
    chunkId: string,
    metadata: Record<string, unknown>
  ): Promise<void>

  /**
   * ç»™ chunk æ‰“åˆ† (å½±å“æœç´¢æƒé‡)
   * ç”¨äº: Agent æ ‡è®°é«˜è´¨é‡/ä½è´¨é‡å†…å®¹
   */
  async scoreChunk(baseId: string, chunkId: string, score: number): Promise<void>
}
```

## ä½¿ç”¨ç¤ºä¾‹

### MCP Tool: æ·»åŠ ç¬”è®°

```typescript
// Agent åœ¨å¯¹è¯ä¸­å­¦ä¹ åˆ°æ–°ä¿¡æ¯ï¼Œå†™å…¥çŸ¥è¯†åº“
const result = await knowledgeFacade.addDocument(baseId, {
  type: 'note',
  data: { content: 'ç”¨æˆ·è¯´é¡¹ç›®Aæ”¹åä¸ºå‡¤å‡°è®¡åˆ’', sourceUrl: 'chat://xxx' },
  metadata: { tags: ['é¡¹ç›®A', 'å‡¤å‡°è®¡åˆ’'], source: 'conversation' }
})
// { itemId: 'xxx', status: 'queued' }
```

### MCP Tool: æœç´¢

```typescript
// Agent æœç´¢çŸ¥è¯†åº“
const results = await knowledgeFacade.search(baseId, 'å‡¤å‡°è®¡åˆ’è¿›åº¦', {
  topK: 5,
  rerank: true
})
```

### MCP Tool: Agent æ ‡æ³¨ (ä¸Šå¸æ¨¡å¼)

```typescript
// Agent å‘ç°è¿‡æ—¶ä¿¡æ¯ï¼Œæ ‡è®°ä¸ºè¿‡æ—¶
await knowledgeFacade.updateChunkMetadata(baseId, chunkId, {
  outdated: true,
  outdatedReason: 'é¡¹ç›®å·²æš‚åœ',
  annotatedBy: 'agent',
  annotatedAt: Date.now()
})
```

### MCP Tool: æŸ¥è¯¢ç»Ÿè®¡ (ä¸Šå¸æ¨¡å¼)

```typescript
// Agent æŸ¥è¯¢çŸ¥è¯†åº“ç»Ÿè®¡ä¿¡æ¯
const stats = await knowledgeFacade.rawQuery(baseId,
  'SELECT COUNT(*) as total, type FROM chunks GROUP BY type'
)
```

## å®ç°è¦ç‚¹

### 1. Facade è°ƒç”¨ DataApi æœåŠ¡

```typescript
class KnowledgeFacade {
  async addDocument(baseId: string, input: AddDocumentInput): Promise<AddDocumentResult> {
    // Facade è°ƒç”¨ ItemServiceï¼Œä¸ç›´æ¥è°ƒç”¨ Orchestrator
    const { items } = await knowledgeItemService.create(baseId, {
      items: [{ type: input.type, data: input.data }]
    })
    return { itemId: items[0].id, status: 'queued' }
  }

  async search(baseId: string, query: string, options?: SearchOptions): Promise<SearchResult[]> {
    // è°ƒç”¨ KnowledgeBaseService.search()
    const base = await knowledgeBaseService.getById(baseId)
    return knowledgeServiceV2.search({ base, search: query })
  }
}
```

### 2. ä¸Šå¸æ¨¡å¼ç›´æ¥è®¿é—® VectorStore

```typescript
class KnowledgeFacade {
  async rawQuery(baseId: string, sql: string): Promise<unknown[]> {
    // å®‰å…¨æ£€æŸ¥: åªå…è®¸ SELECT
    if (!sql.trim().toUpperCase().startsWith('SELECT')) {
      throw new Error('Only SELECT queries are allowed in rawQuery')
    }
    // ç›´æ¥æŸ¥è¯¢ LibSQLVectorStore
    return knowledgeServiceV2.rawQuery(baseId, sql)
  }

  async getChunks(baseId: string, itemId: string): Promise<ChunkInfo[]> {
    return knowledgeServiceV2.getChunksByItemId(baseId, itemId)
  }
}
```

## æ–‡ä»¶ä½ç½®

```
src/main/services/knowledge/
â”œâ”€â”€ KnowledgeFacade.ts          # å¯¹å¤–ç»Ÿä¸€æ¥å£
â”œâ”€â”€ KnowledgeOrchestrator.ts    # åè°ƒå±‚
â”œâ”€â”€ KnowledgeProcessor.ts       # å¤„ç†å±‚
â”œâ”€â”€ KnowledgeServiceV2.ts       # å­˜å‚¨å±‚
â”œâ”€â”€ queue/
â”‚   â””â”€â”€ KnowledgeQueueManager.ts
â””â”€â”€ ...
```

## ä¸ Agentic RAG çš„å…³ç³»

å‚è§ [knowledge-v2.md](./knowledge-v2.md) ä¸­çš„ Agentic RAG æ„¿æ™¯ã€‚

`KnowledgeFacade` æ˜¯å®ç° Agentic RAG çš„åŸºç¡€è®¾æ–½ï¼š

| èƒ½åŠ› | Facade API | è¯´æ˜ |
|------|-----------|------|
| åŸºç¡€ RAG | `search()` | æ··åˆæ£€ç´¢ + é‡æ’åº |
| çŸ¥è¯†ç»´æŠ¤ | `addDocument()` | Agent å¯¹è¯ä¸­ç›´æ¥å†™å…¥ |
| æ™ºèƒ½æ ‡æ³¨ | `updateChunkMetadata()` | Agent æ ‡è®°è¿‡æ—¶ã€æ‰“åˆ† |
| ä¸Šå¸æ¨¡å¼ | `rawQuery()` | Agent è‡ªç”±æ¢ç´¢çŸ¥è¯†åº“ |

é€šè¿‡ `KnowledgeFacade`ï¼ŒAgent å¯ä»¥ï¼š
1. åœ¨å¯¹è¯ä¸­å­¦ä¹ æ–°çŸ¥è¯†å¹¶å†™å…¥çŸ¥è¯†åº“
2. å‘ç°è¿‡æ—¶ä¿¡æ¯æ—¶ä¸»åŠ¨æ ‡æ³¨
3. ç»™é«˜è´¨é‡å†…å®¹æ‰“åˆ†ï¼Œæå‡æ£€ç´¢æƒé‡
4. è‡ªç”±æŸ¥è¯¢çŸ¥è¯†åº“ç»“æ„å’Œç»Ÿè®¡ä¿¡æ¯
