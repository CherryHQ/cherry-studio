name: GitHub Issue Tracker with Feishu Notification

on:
  issues:
    types: [opened]
  schedule:
    # Run every day at 8:30 Beijing Time (00:30 UTC)
    - cron: '30 0 * * *'
  workflow_dispatch:

jobs:
  process-new-issue:
    if: github.event_name == 'issues'
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check Beijing Time
        id: check_time
        run: |
          # Get current time in Beijing timezone (UTC+8)
          BEIJING_HOUR=$(TZ='Asia/Shanghai' date +%H)
          BEIJING_MINUTE=$(TZ='Asia/Shanghai' date +%M)

          echo "Beijing Time: ${BEIJING_HOUR}:${BEIJING_MINUTE}"

          # Check if time is between 00:00 and 08:30
          if [ $BEIJING_HOUR -lt 8 ] || ([ $BEIJING_HOUR -eq 8 ] && [ $BEIJING_MINUTE -le 30 ]); then
            echo "should_delay=true" >> $GITHUB_OUTPUT
            echo "â° Issue created during quiet hours (00:00-08:30 Beijing Time)"
            echo "Will schedule notification for 08:30"
          else
            echo "should_delay=false" >> $GITHUB_OUTPUT
            echo "âœ… Issue created during active hours, will notify immediately"
          fi

      - name: Add pending label if in quiet hours
        if: steps.check_time.outputs.should_delay == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['pending-feishu-notification']
            });

      - name: Setup Node.js
        if: steps.check_time.outputs.should_delay == 'false'
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Summarize issue with Claude
        if: steps.check_time.outputs.should_delay == 'false'
        id: summarize
        uses: anthropics/claude-code-action@main
        with:
          anthropic_api_key: ${{ secrets.CLAUDE_TRANSLATOR_APIKEY }}
          prompt: |
            Please analyze this GitHub issue and provide a concise summary in Chinese (ä¸­æ–‡).

            Issue #${{ github.event.issue.number }}: ${{ github.event.issue.title }}
            Author: ${{ github.event.issue.user.login }}
            URL: ${{ github.event.issue.html_url }}

            Issue Body:
            ${{ github.event.issue.body }}

            Please provide:
            1. A brief Chinese summary of the issue (2-3 sentences)
            2. The main problem or request
            3. Any important technical details mentioned

            Format your response in clean markdown, suitable for display in a notification card.
            Keep it concise but informative.
        env:
          ANTHROPIC_BASE_URL: ${{ secrets.CLAUDE_TRANSLATOR_BASEURL }}

      - name: Send to Feishu immediately
        if: steps.check_time.outputs.should_delay == 'false'
        env:
          FEISHU_WEBHOOK_URL: ${{ secrets.FEISHU_WEBHOOK_URL }}
          FEISHU_WEBHOOK_SECRET: ${{ secrets.FEISHU_WEBHOOK_SECRET }}
          ISSUE_URL: ${{ github.event.issue.html_url }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_AUTHOR: ${{ github.event.issue.user.login }}
          ISSUE_LABELS: ${{ join(github.event.issue.labels.*.name, ',') }}
          ISSUE_SUMMARY: ${{ steps.summarize.outputs.response }}
        run: |
          node scripts/feishu-notify.js

      - name: Comment on issue
        if: steps.check_time.outputs.should_delay == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const summary = `${{ steps.summarize.outputs.response }}`;
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `## ğŸ¤– AI Summary\n\n${summary}\n\n---\n*This summary was generated by Claude and has been sent to the team via Feishu.*`
            });

  process-pending-issues:
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Process pending issues with Claude
        uses: anthropics/claude-code-action@main
        with:
          anthropic_api_key: ${{ secrets.CLAUDE_TRANSLATOR_APIKEY }}
          allowed_non_write_users: "*"
          github_token: ${{ secrets.GITHUB_TOKEN }}
          claude_args: "--allowed-tools Bash(gh issue:*),Bash(gh api:*),Bash(node scripts/feishu-notify.js)"
          prompt: |
            ä½ æ˜¯ä¸€ä¸ªGitHub Issueè‡ªåŠ¨åŒ–å¤„ç†åŠ©æ‰‹ã€‚è¯·å®Œæˆä»¥ä¸‹ä»»åŠ¡ï¼š

            ## ä»»åŠ¡è¯´æ˜
            å¤„ç†æ‰€æœ‰å¾…å‘é€é£ä¹¦é€šçŸ¥çš„GitHub Issuesï¼ˆæ ‡è®°ä¸º `pending-feishu-notification` çš„issuesï¼‰

            ## æ­¥éª¤

            1. **è·å–å¾…å¤„ç†çš„issues**
               ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤è·å–æ‰€æœ‰å¸¦ `pending-feishu-notification` æ ‡ç­¾çš„issuesï¼š
               ```bash
               gh api repos/${{ github.repository }}/issues?labels=pending-feishu-notification&state=open
               ```

            2. **æ€»ç»“æ¯ä¸ªissue**
               å¯¹äºæ¯ä¸ªæ‰¾åˆ°çš„issueï¼Œç”¨ä¸­æ–‡æä¾›ç®€æ´çš„æ€»ç»“ï¼ˆ2-3å¥è¯ï¼‰ï¼ŒåŒ…æ‹¬ï¼š
               - é—®é¢˜çš„ä¸»è¦å†…å®¹
               - æ ¸å¿ƒè¯‰æ±‚
               - é‡è¦çš„æŠ€æœ¯ç»†èŠ‚

            3. **å‘é€é£ä¹¦é€šçŸ¥**
               å¯¹äºæ¯ä¸ªissueï¼Œä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å‘é€é£ä¹¦é€šçŸ¥ï¼š
               ```bash
               ISSUE_URL="<issueçš„html_url>" \
               ISSUE_NUMBER="<issueç¼–å·>" \
               ISSUE_TITLE="<issueæ ‡é¢˜>" \
               ISSUE_AUTHOR="<issueä½œè€…>" \
               ISSUE_LABELS="<é€—å·åˆ†éš”çš„æ ‡ç­¾åˆ—è¡¨ï¼Œæ’é™¤pending-feishu-notification>" \
               ISSUE_SUMMARY="<ä½ ç”Ÿæˆçš„ä¸­æ–‡æ€»ç»“>" \
               node scripts/feishu-notify.js
               ```

            4. **ç§»é™¤æ ‡ç­¾**
               æˆåŠŸå‘é€åï¼Œä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ç§»é™¤ `pending-feishu-notification` æ ‡ç­¾ï¼š
               ```bash
               gh api -X DELETE repos/${{ github.repository }}/issues/<issueç¼–å·>/labels/pending-feishu-notification
               ```

            5. **æ·»åŠ è¯„è®º**
               ä¸ºæ¯ä¸ªå¤„ç†çš„issueæ·»åŠ AIæ€»ç»“è¯„è®ºï¼š
               ```bash
               gh issue comment <issueç¼–å·> --body "## ğŸ¤– AI Summary

               <ä½ ç”Ÿæˆçš„ä¸­æ–‡æ€»ç»“>

               ---
               *This summary was generated by Claude and has been sent to the team via Feishu.*"
               ```

            ## ç¯å¢ƒå˜é‡
            - Repository: ${{ github.repository }}
            - Feishu webhook URLå’Œå¯†é’¥å·²åœ¨ç¯å¢ƒå˜é‡ä¸­é…ç½®å¥½

            ## æ³¨æ„äº‹é¡¹
            - å¦‚æœæ²¡æœ‰å¾…å¤„ç†çš„issuesï¼Œè¾“å‡ºæç¤ºä¿¡æ¯åç›´æ¥ç»“æŸ
            - å¤„ç†å¤šä¸ªissuesæ—¶ï¼Œæ¯ä¸ªissueä¹‹é—´ç­‰å¾…2-3ç§’ï¼Œé¿å…APIé™æµ
            - å¦‚æœæŸä¸ªissueå¤„ç†å¤±è´¥ï¼Œç»§ç»­å¤„ç†ä¸‹ä¸€ä¸ªï¼Œä¸è¦ä¸­æ–­æ•´ä¸ªæµç¨‹
            - æ‰€æœ‰æ€»ç»“å¿…é¡»ä½¿ç”¨ä¸­æ–‡ï¼ˆç®€ä½“ä¸­æ–‡ï¼‰

            è¯·å¼€å§‹æ‰§è¡Œä»»åŠ¡ï¼
        env:
          ANTHROPIC_BASE_URL: ${{ secrets.CLAUDE_TRANSLATOR_BASEURL }}
          FEISHU_WEBHOOK_URL: ${{ secrets.FEISHU_WEBHOOK_URL }}
          FEISHU_WEBHOOK_SECRET: ${{ secrets.FEISHU_WEBHOOK_SECRET }}
