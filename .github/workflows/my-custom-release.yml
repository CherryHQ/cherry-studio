name: My Custom Auto Release

on:
  schedule:
    - cron: "0 6 * * *" # 每天 14:00 BJ Time 检测一次上游更新
  workflow_dispatch:
    inputs:
      force_tag:
        description: "若需手动打包特定 Tag 请在此填写（例如 v1.0.0）。留空则自动检测是否有新版本。"
        required: false
        default: ""

permissions:
  contents: write

jobs:
  sync_and_prepare:
    runs-on: ubuntu-latest
    outputs:
      should_build: ${{ steps.check.outputs.should_build }}
      tag: ${{ steps.check.outputs.tag }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Check and Sync
        id: check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # 1. 手动指定 Tag
          INPUT_TAG="${{ github.event.inputs.force_tag }}"
          
          if [ -n "$INPUT_TAG" ]; then
            if [[ "$INPUT_TAG" != v* ]]; then
               INPUT_TAG="v$INPUT_TAG"
            fi
            echo "Manual tag $INPUT_TAG detected."
            echo "should_build=true" >> $GITHUB_OUTPUT
            echo "tag=$INPUT_TAG" >> $GITHUB_OUTPUT
            exit 0
          fi

          # 2. 从官方拉取最新的版本 Tags 作为检测探测器
          git clone --bare https://github.com/CherryHQ/cherry-studio.git upstream_repo
          LATEST_TAG=$(cd upstream_repo && git tag -l "v*" --sort=-v:refname | head -n 1)
          
          if [ -z "$LATEST_TAG" ]; then
            echo "No tags found on upstream."
            echo "should_build=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "Latest upstream tag: $LATEST_TAG"
          
          # 3. 检查我们当前仓库是不是已经发布过这个版本 Release
          if gh release view "$LATEST_TAG" > /dev/null 2>&1; then
            echo "Release $LATEST_TAG already exists in this repo. Skipping."
            echo "should_build=false" >> $GITHUB_OUTPUT
          else
            echo "New release detected: $LATEST_TAG"
            
            # 【优雅的同步手段】 - 仅在有稳定的 Release 产生时，才签下该稳定版的 commit 与本地合并
            git remote add upstream https://github.com/CherryHQ/cherry-studio.git || true
            git fetch upstream refs/tags/"$LATEST_TAG":refs/tags/"$LATEST_TAG" || true
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            
            git merge "$LATEST_TAG" --no-commit --no-ff || true
            git restore --staged .github/workflows/ || true
            git checkout HEAD -- .github/workflows/ || true
            
            git commit -m "chore: sync stable release $LATEST_TAG from upstream excluding workflows modifications" || true
            git push origin main || true
            
            # 不要去推送 tag，让 Release 阶段自动补上空壳关联
            echo "should_build=true" >> $GITHUB_OUTPUT
            echo "tag=$LATEST_TAG" >> $GITHUB_OUTPUT
          fi

  build_and_release:
    needs: sync_and_prepare
    if: needs.sync_and_prepare.outputs.should_build == 'true'
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [macos-latest, windows-latest, ubuntu-latest]
      fail-fast: false

    steps:
      - name: Check out official repository cleanly
        uses: actions/checkout@v6
        with:
          # 神来之笔：我们直接拉取官方的原版 tag 代码当场编译，拒绝任何中间的 Git Merge 本地混淆
          repository: CherryHQ/cherry-studio
          ref: ${{ needs.sync_and_prepare.outputs.tag }}

      - name: Set package.json version
        shell: bash
        run: |
          TAG="${{ needs.sync_and_prepare.outputs.tag }}"
          VERSION="${TAG#v}"
          npm version "$VERSION" --no-git-tag-version --allow-same-version

      - name: Install Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 22

      - name: macos-latest dependencies fix
        if: matrix.os == 'macos-latest'
        run: |
          brew install python-setuptools

      - name: Install pnpm
        uses: pnpm/action-setup@v4

      - name: Get pnpm store directory
        id: pnpm-cache
        shell: bash
        run: echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_OUTPUT

      - name: Cache pnpm dependencies
        uses: actions/cache@v5
        with:
          path: ${{ steps.pnpm-cache.outputs.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-

      - name: Install Dependencies
        run: pnpm install

      - name: Build Linux
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get install -y rpm
          pnpm build:linux
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NODE_OPTIONS: --max-old-space-size=8192
          MAIN_VITE_CHERRYAI_CLIENT_SECRET: ${{ secrets.MAIN_VITE_CHERRYAI_CLIENT_SECRET }}
          MAIN_VITE_MINERU_API_KEY: ${{ secrets.MAIN_VITE_MINERU_API_KEY }}
          RENDERER_VITE_AIHUBMIX_SECRET: ${{ secrets.RENDERER_VITE_AIHUBMIX_SECRET }}
          RENDERER_VITE_PPIO_APP_SECRET: ${{ secrets.RENDERER_VITE_PPIO_APP_SECRET }}

      - name: Build Mac
        if: matrix.os == 'macos-latest'
        run: |
          sudo -H pip install setuptools || true
          pnpm build:mac
        env:
          CSC_LINK: ${{ secrets.CSC_LINK }}
          CSC_KEY_PASSWORD: ${{ secrets.CSC_KEY_PASSWORD }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NODE_OPTIONS: --max-old-space-size=8192
          MAIN_VITE_CHERRYAI_CLIENT_SECRET: ${{ secrets.MAIN_VITE_CHERRYAI_CLIENT_SECRET }}
          MAIN_VITE_MINERU_API_KEY: ${{ secrets.MAIN_VITE_MINERU_API_KEY }}
          RENDERER_VITE_AIHUBMIX_SECRET: ${{ secrets.RENDERER_VITE_AIHUBMIX_SECRET }}
          RENDERER_VITE_PPIO_APP_SECRET: ${{ secrets.RENDERER_VITE_PPIO_APP_SECRET }}

      - name: Build Windows
        if: matrix.os == 'windows-latest'
        run: pnpm build:win
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NODE_OPTIONS: --max-old-space-size=8192
          MAIN_VITE_CHERRYAI_CLIENT_SECRET: ${{ secrets.MAIN_VITE_CHERRYAI_CLIENT_SECRET }}
          MAIN_VITE_MINERU_API_KEY: ${{ secrets.MAIN_VITE_MINERU_API_KEY }}
          RENDERER_VITE_AIHUBMIX_SECRET: ${{ secrets.RENDERER_VITE_AIHUBMIX_SECRET }}
          RENDERER_VITE_PPIO_APP_SECRET: ${{ secrets.RENDERER_VITE_PPIO_APP_SECRET }}

      - name: Upload to Github Release
        uses: ncipollo/release-action@v1
        with:
          draft: false
          allowUpdates: true
          makeLatest: true
          # 指定创建关联在本库 main 分支的 Release
          commit: "main" 
          name: "Cherry Studio ${{ needs.sync_and_prepare.outputs.tag }}"
          tag: ${{ needs.sync_and_prepare.outputs.tag }}
          artifacts: "dist/*.exe,dist/*.zip,dist/*.dmg,dist/*.AppImage,dist/*.snap,dist/*.deb,dist/*.rpm,dist/*.tar.gz,dist/latest*.yml,dist/rc*.yml,dist/beta*.yml,dist/*.blockmap"
          token: ${{ secrets.GITHUB_TOKEN }}

